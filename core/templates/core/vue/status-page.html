{% extends "../vue/header.html" %}
{% load staticfiles %}

{% block body %}
<div id="app">
  <b-container fluid id="main-container">
    <b-row class="text-center custom-row">
      <b-col class="main-menu" style="margin-right: 4px">
        <md-card class="pipeline-tag">
          <md-card-content>
          <md-field>
            <label>Search by Title</label>
            <md-input v-model="search"></md-input>
          </md-field>
          </md-card-content>
          <md-divider></md-divider>
          <md-card-content class="tag-list">
            <button class="project-button"  @click="fetchWetlab()" squared><span>Wetlab</span></button>
<!--             <button v-for="tag in tags" @click="fetchSamples(tag.id)" class="project-button" squared><span>{% verbatim %}{{tag.title}}{% endverbatim %}</span></button> -->
            <button v-if="!search" v-for="tag in tags" @click="fetchSamples(tag.id)" class="project-button" squared><span>{% verbatim %}{{tag.title}}{% endverbatim %}</span></button>
            <button v-else v-for="tag in searchedTagResults" @click="fetchSamples(tag.id)" :model="searchTags" class="project-button" squared><span>{% verbatim %}{{tag.title}}{% endverbatim %}</span></button>
          </md-card-content>
          <md-card-actions >
                <md-button>Edit</md-button>
                <md-button>Add</md-button>
          </md-card-actions>
        </md-card>
      </b-col>
      <b-col class="main-table"> 
        <md-card class="main-content">
          <br />
          <div class="sample-table">
            <b-button-group style="margin-top : 1px; height: 40px;">
                <b-button squared class="menu-button" style="width:140px;">sample ID</b-button>                
                <b-button class="menu-button" style="width:110px;">library ID</b-button>
                <b-button class="menu-button" style="width:100px;">Analysis</b-button>
                <b-button class="menu-button" style="width:100px;">Version</b-button>
                <b-button class="menu-button" style="width:100px;">Aligner</b-button>
                <b-button class="menu-button" style="width:100px;">Lanes</b-button>
                <b-button class="menu-button" style="width:100px;">Montage</b-button>
                <b-button class="menu-button" style="width:170px;">Pipeline</b-button>
                <b-button class="menu-button" style="width:110px;">Pseudobulk</b-button>
                <b-button class="menu-button" style="width:110px;">Submitted</b-button>
                <b-button squared class="menu-button" style="width:130px;">Last Updated</b-button>
            </b-button-group>
            <div class="content-table">         
              <Row v-for="sample in samples" :key="sample.id" :sample="sample" />
            </div>
          </div>
          <br />
        </md-card >
      </b-col>
    </b-row>
  </b-container>
</div>
<script>

var Row =  {
  props: ['sample'],
  methods: {
    setShow() {this.sample.show = !this.sample.show},
    returnURL(type,pk) { 
      return window.origin + type + "/" + pk
      },
    returnJiraURL(jira) {return "//www.bcgsc.ca/jira/browse/" + jira },
  },
  template: `
  <b-button-group @click="setShow" style="margin-top : 1px;">
    <b-button squared class="row-button sample-name" style=width:140px;" :href="returnURL('/core/sample',sample.id)">{% verbatim %}{{sample.name}}{{sample.imported}}{% endverbatim %}</b-button>
    <b-button v-if="sample.library" class="row-button" style="width:110px;" :href="returnURL('/dlp/library',sample.library)">
        {% verbatim %}{{sample.library}}{% endverbatim %}
    </b-button>
    <b-button class="row-button" v-else style="width:110px;" >
    <b-badge variant="warning">No DLP</b-badge> 
    </b-button>
    <b-button v-if="sample.jira" class="row-button" style="width:100px;" :href="returnJiraURL(sample.jira)">
     {% verbatim %}{{sample.jira}}{% endverbatim %}
    </b-button>
    <b-button v-else class="row-button" style="width:100px;" >
    <b-badge variant="warning">No Analysis</b-badge> 
    </b-button>
    <b-button v-if="sample.version" class="row-button" style="width:100px;">
      <b-badge variant="primary">
      {% verbatim %}{{sample.version}}{% endverbatim %}
      </b-badge>
    </b-button>
    <b-button v-else class="row-button" style="width:100px;">N/A</b-button>
    <b-button v-if="sample.aligner" class="row-button" style="width:100px;">
      <b-badge variant="primary">
      {% verbatim %}{{sample.aligner}}{% endverbatim %}
      </b-badge>
    </b-button>
    <b-button v-else class="row-button" style="width:100px;">N/A</b-button>
    <b-button v-if="sample.lanes" class="row-button" style="width:100px;">
      <b-badge variant="primary">
      {% verbatim %}{{sample.lanes}}{% endverbatim %}
      </b-badge>
    </b-button>
    <b-button v-else class="row-button" style="width:100px;">N/A</b-button>
    <b-button class="row-button" style="width:100px;" :href="returnJiraURL(sample.jira)">Link</b-button>
    <b-button class="row-button">
      <b-badge :variant="sample.pipeline.align">align</b-badge>
      <b-badge :variant="sample.pipeline.hmmcopy">hmmcopy</b-badge>
      <b-badge :variant="sample.pipeline.qc">QC</b-badge>
    </b-button>
    <b-button  class="row-button" style="width:110px;">
      <b-badge :variant="sample.pipeline.pseudo">pseudobulk</b-badge>
    </b-button>
    <b-button v-if="sample.submission" class="row-button" style="width:110px;">
      <b-badge variant="primary">
      {% verbatim %}{{sample.submission}}{% endverbatim %}
      </b-badge>
    </b-button>
    <b-button v-else class="row-button" style="width:110px;">N/A</b-button>
    <b-button squared v-if="sample.last_updated" class="row-button" style="width:130px;">
      <b-badge variant="primary">
      {% verbatim %}{{sample.last_updated}}{% endverbatim %}
      </b-badge>
    </b-button>
    <b-button squared v-else class="row-button" style="width:130px;">N/A</b-button>
  </b-button-group>   
  
  `
  }
          

  var vm = new Vue({
    el: '#app',
    data: {
      samples: [],
      tags: [],
      search: "",
      searching: "",
      searchedTagResults: [],
    },
    methods: {  
      setPipeline(i) {
        this.samples[i].pipeline["qc"] = "primary"
      },    
      setRunStatus(status) {
        // console.log("setRunStatus")
        let variant = "secondary"
        let run_status = { 
          dark: 'idle',
          info: 'running',
          primary: 'archiving',
          danger: 'error',
          success:'complete'}
        Object.entries(run_status).forEach(([key, val]) => {
          if(status.includes(val)) {
            variant = key
          }
        });
        return variant
      },
      fetchWetlab() {
        console.log("fetchWetlab")
        axios({
                method: 'post',
                url: "{% url 'core:pipeline_status_request_handler' %}",
                dataType: "json",
                data: {"type" : "fetchWetlab"},
                headers: {
                  "X-CSRFToken": Cookies.get('csrftoken'),
                  "content-type": "application/json"
                }}
            ).then( (response) => {
              this.samples = response.data.samples  
              this.samples.forEach( sample => {
                if(sample.jira) this.axiosVerifyTantalus(sample)
                if(sample.jira) this.axiosVerifyColossus(sample)
                // console.log(`imported is ${sample.imported}`)
              })
              }
              )    
      },
      fetchSamples (id) {
        console.log("fetchSamples")
        axios({
                method: 'post',
                url: "{% url 'core:pipeline_status_request_handler' %}",
                dataType: "json",
                data: {"type" : "fetchSample", "id" : id},
                headers: {
                  "X-CSRFToken": Cookies.get('csrftoken'),
                  "content-type": "application/json"
                }}
            ).then( (response) => {
              this.samples = response.data.samples  
              this.samples.forEach( sample => {
                if(sample.jira) this.axiosVerifyTantalus(sample)
                if(sample.jira) this.axiosVerifyColossus(sample)
              })
              }
              )
      },
      axiosVerifyColossus(sample){
        console.log("axiosVerifyColossus")

        axios({
                method: 'post',
                url: "{% url 'core:pipeline_status_request_handler' %}",
                dataType: "json",
                data:{"type" : "validateColossus", "id" : jira}, 
                headers: {
                  "X-CSRFToken": Cookies.get('csrftoken'),
                  "content-type": "application/json"
                }}
            ).then( (response) => {
              console.log(`response is ${response.data}`)

                sample.imported = response.data ? "#c8e6c5" : "grey";
                console.log(sample.imported)
            }
            )
      },
      axiosVerifyTantalus (sample) {
        console.log("axiosVerifyTantalus")
        jira = sample.jira
        library = sample.library
        let token = "JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxNiwidXNlcm5hbWUiOiJqcGhhbSIsImV4cCI6MTU2NDAwMTEzMSwiZW1haWwiOiIiLCJvcmlnX2lhdCI6MTU2MzM5NjMzMX0.DpU0SFgS390B1KCMKI3bUMVUwFocw3X-Qodlz8K848A"
        const url = "https://tantalus.canadacentral.cloudapp.azure.com/api/analysis/"
        
        // Qc, hmmcopy and align 
        axios
        .get(url,{ headers : { Authorization : token},
        params : {jira_ticket : jira}})
        .then(r => {
          r.data.results.forEach(a => {
            atype = a.analysis_type
            status = a.status
            if (atype in sample.pipeline) {
              sample["pipeline"][atype]= this.setRunStatus(status)
              }
            })
            if ((sample.pipeline["align"] === "success") && (sample.pipeline["hmmcopy"] === "success")) sample["pipeline"]["qc"]= "success"
            })
        .catch(e => {console.log(e.response)})

        // Pseudobulk
        axios
        .get(url,{ headers : { Authorization : token},
        params : {input_datasets__library__library_id : library, analysis_type__name: "pseudobulk"}})
        .then(r => {if(r.data.count > 0) sample["pipeline"]["pseudo"]= this.setRunStatus(status)})
        .catch(e => {console.log(e.response)})        
      },

      searchTags() {

        for (var i; i < this.tags.length; i++){
          if this.tags[i].title.includes(this.search) {
            searchTags.push(this.tags[i].title)
            console.log(`adding ${this.tags[i].title} to searchTags`)
          }
        }
      //     console.log("hello")
          // tags.forEach(function(tag) {
          //   if tag.includes(this.search) {
          //     searchTags.push(tag)
          //   }
          // })
      }
    },
    components:{
      Row
    },
    created () {
      console.log("created")
      this.tags = JSON.parse(unescape("{{tags| safe | escapejs}}"))
      this.samples = JSON.parse(unescape("{{samples| safe | escapejs}}"))
    },
  })
</script>

<style>
#main-container {
  padding-top: 4%;
}

.tag-list {
  max-height:500px;
  height: 430px;
  overflow-y: scroll;
}

.main-menu {
  max-width: 200px;
}

.pipeline-tag {
  width: 200px;
  height: 600px;
}


.main-content {
  overflow-x: auto;
  width: 95%;
}

.main-table {
  width: 200px;
}

.content-table {
  max-height: 600px;
  overflow-y: auto;
}

.sample-table {
  border-radius: 5px;
  padding: 2px;
  min-width: 1280px;
}

.menu-button {
  background-color:rgb(190, 182, 182);
  color: black;
}

.project-button {
  border: none;
  background-color: #a9a9b0;
  width: 160px;
  height: 33px;
  margin: 1px;
}

.row-description {
  background-color:whitesmoke;
  border: 0.5px solid grey;
}
.sample-name {
  font-size: 10px;
  text-align: left;
  font-weight: 800;
}

.row-button {
  background-color:whitesmoke;
  color: black;
}

.row-imported {
  background-color: #c8e6c5;
}

</style>

{% endblock %}

