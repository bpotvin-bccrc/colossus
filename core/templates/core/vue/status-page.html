{% extends "../vue/header.html" %}
{% load staticfiles %}

{% block body %}
<div id="app">    
    <div class="page-container">
        <md-app md-mode="fixed">
          <md-app-toolbar md-elevation="0">
            <span class="md-title">Analysis Status {% verbatim %}{{radio}}{% endverbatim %}</span>
            <md-button  @click="showDialog = true">Guide <md-icon>contact_support</md-icon></md-button>
            {% include "core/vue/status-tutorial.html" %}
            <md-button @click="showFilter =true">Filter <md-icon>filter_list</md-icon></md-button>
            <md-dialog :md-active.sync="showFilter">
                <md-dialog-title>Filter Table</md-dialog-title>
                <md-dialog-content> 
                  <div>
                      <md-field>
                        <label>Sample ID, Library ID or JIRA </label>
                        <md-input v-model="searchQuery.key"></md-input>
                      </md-field>
                      <md-datepicker v-model="searchQuery.submission">
                          <label>Submitted date</label>
                      </md-datepicker>
                      <md-datepicker v-model="searchQuery.updated">
                          <label>Updated date</label>
                      </md-datepicker>
                      
                      <p>Only Completed:</p>
                      <md-switch v-model="searchQuery.completed[0]">align</md-switch>
                      <md-switch v-model="searchQuery.completed[1]">hmmcopy</md-switch>
                      <md-switch v-model="searchQuery.completed[2]">qc</md-switch>
                      <md-switch v-model="searchQuery.completed[3]">pseudobulk</md-switch>
                    </div>
                  <md-dialog-actions>
                      <md-button class="md-primary" @click="resetFilter">Reset</md-button>
                      <md-button class="md-primary" @click="showFilter = false">Close</md-button>
                  </md-dialog-actions>
                </md-dialog-content>
            </md-dialog>
          </md-app-toolbar>
          
          <md-app-drawer md-permanent="full">
            <md-list class="md-double-line" style="height: 100vh;">
              <md-subheader>Hello Ssong</md-subheader>
              <md-list-item>
                <md-field>
                  <label>Search by Title</label>
                  <md-input v-model="searchTag"></md-input>
                </md-field>
              </md-list-item>
              <md-divider></md-divider>
              <md-subheader>My Projects List</md-subheader>
              <div class="project-list">                
              <md-list-item v-for="tag in tags">
                <md-radio v-model="radio" :value="tag.name" @change="fetchSamples"/>
                <span class="md-list-item-text"> {% verbatim %}{{tag.name}}{% endverbatim %}</span>
              </md-list-item>
              </div>
              <md-button @click="createTag()"><md-icon>add</md-icon></md-button>
            </md-list>
            
          </md-app-drawer>
    
          <md-app-content>
              <md-card style="width: 600px;">
                
              </md-card>
              <div class="main-content">
                  <br />
                  <div class="sample-table">
                      <md-table v-model="rowDisplay" md-fixed-header md-height="calc(80vh - 40px)" md-sort="submitted" md-sort-order="asc">
                          <md-table-row slot="md-table-row" slot-scope="{ item }" :style="item.imported">
                            <md-table-cell class="ln140" md-label="Submitted" md-sort-by="submitted" >
                              <div v-if="item.submission">
                                {% verbatim %}{{item.submission}}{% endverbatim %}
                              </div>
                              <b-badge variant="secondary" v-else>N/A</b-button>                              
                            </md-table-cell>
                            <md-table-cell md-label="Updated">
                              <div v-if="item.last_updated">
                              {% verbatim %}{{item.last_updated}}{% endverbatim %}
                              </div>
                              <b-badge variant="secondary" v-else>N/A</b-button>                               
                            </md-table-cell>
                            <md-table-cell md-label="Sample ID">
                              <a :href="returnURL('/core/sample',item.name)">
                              {% verbatim %}{{item.name}}{% endverbatim %}
                              </a>
                            </md-table-cell>
                            <md-table-cell md-label="Library">
                              <div v-if="item.library">
                                <a :href="returnURL('/dlp/library',item.library)">
                                {% verbatim %}{{item.library}}{% endverbatim %}
                                </a>
                              </div>
                              <b-badge variant="secondary" v-else>N/A</b-button>                              
                            </md-table-cell>                            
                            <md-table-cell md-label="Analysis">
                              <div v-if="item.jira">
                                <a href="returnJiraURL(item.jira)">
                                {% verbatim %}{{item.jira}}{% endverbatim %}
                                </a>
                              </div>
                              <b-badge variant="secondary" v-else>N/A</b-button>                              
                            </md-table-cell>
                            <md-table-cell md-label="Montage">
                              <div v-if="item.montage">
                                <a :href="returnMontageURL(item.jira)"> Link </a>
                              </div>
                              <b-badge variant="secondary" v-else>N/A</b-button>
                            </md-table-cell>
                            <md-table-cell  md-label="Version">
                              <div v-if="item.version">
                                {% verbatim %}{{item.version}}{% endverbatim %}
                              </div>
                              <b-badge variant="secondary" v-else>N/A</b-button>
                            </md-table-cell>
                            <md-table-cell md-label="Aligner">
                              <div v-if="item.aligner">
                                {% verbatim %}{{item.aligner}}{% endverbatim %}
                              </div>
                              <b-badge variant="secondary" v-else>N/A</b-button>
                            </md-table-cell>
                            <md-table-cell md-label="Lanes">  
                              <div v-if="item.lanes" variant="primary">
                                {% verbatim %}{{item.lanes}}{% endverbatim %}
                              </div>
                              <b-badge  variant="secondary" v-else>N/A</b-badge>
                            </md-table-cell>
                            <md-table-cell style="min-width: 180px;" md-label="Pipeline">
                              <div>
                                <b-badge :variant="item.pipeline.align">align</b-badge>
                                <b-badge :variant="item.pipeline.hmmcopy">hmmcopy</b-badge>
                                <b-badge :variant="item.pipeline.qc">QC</b-badge>
                              </div>
                            </md-table-cell>
                            <md-table-cell md-label="Pseudobulk">
                              <b-badge :variant="item.pipeline.pseudo">pseudobulk</b-badge>
                            </md-table-cell>
                          </md-table-row>
                        </md-table-row>
                      </md-table>
                  </div>
                  <br />
                </div >
          </md-app-content>
        </md-app>
      </div>
  </div>
{% include "core/vue/status-row.html" %}
<script>
  var vm = new Vue({
    el: '#app',
    components:{
      Row
    },
    data: {
      showDialog: false,
      showFilter: false,
      showWetlab: true,
      searchQuery: {
        key : "",
        submission: null,
        updated: null,
        completed: [false, false, false, false]
      },
      username: "",
      password: "",
      samples: [],
      tags: [],
      radio: "Wetlab",
      montages: [],
      montage_ready: false,
      searchTag: "",
    },
    created () {
      this.tags = JSON.parse(unescape("{{tags| safe | escapejs}}"))
      this.tags.forEach( tag => {
        Vue.set(tag,"selected",false)
      })
      this.tags.unshift({name: 'Wetlab',selected : true, id:-1})
      this.username = "ssong"
      this.password = "Iamsuperstar1#"
      // this.username = "{{username| safe | escapejs}}"
      // this.password = "{{password| safe | escapejs}}"
      this.fetchSamples()
      this.axiosColossus({type : "fetchMontage"})
      .then((r) => {
        this.montage_ready=true
        this.montages = r
        this.updateSampleMontage()
      })
    },
    computed: {
      tagDisplay() {
        return this.tags.filter(tag => {return tag.title.toLowerCase().includes(this.searchTag.toLowerCase())})
      },
      rowDisplay() {
        return this.samples.filter(sample => {
          query = true
          if (this.searchQuery.submission)
            if(sample.submission) query &= (this.searchQuery.submission.toISOString().split('T')[0] === sample.submission)
            else return false
          if (this.searchQuery.updated)
            if(sample.last_updated) query &= (this.searchQuery.updated.toISOString().split('T')[0] === sample.last_updated)
            else return false
          if(this.searchQuery.key)
            query &= (sample.library + sample.name + ((sample.jira) ? sample.jira : "")).toLowerCase().includes(this.searchQuery.key.toLowerCase())
          if(this.searchQuery.completed[0]) query &= (sample.pipeline.align === "success")
          if(this.searchQuery.completed[1]) query &= (sample.pipeline.hmmcopy === "success")
          if(this.searchQuery.completed[2]) query &= (sample.pipeline.qc === "success")
          if(this.searchQuery.completed[3]) query &= (sample.pipeline.pseudo === "success")
          return query
        })
      }
    },
    methods: {  
      returnURL(type,pk) {
      return window.origin + type + "/" + pk
      },
      returnJiraURL(jira) {return "//www.bcgsc.ca/jira/browse/" + jira },
      returnMontageURL(jira) {return "//https://52.235.35.201/?dashboard=" + jira},
      createTag(){window.location.href = ""},
      resetFilter() {
        this.searchQuery = {
        key : "",
        submission: null,
        updated: null,
        completed: [false, false, false, false]}
      },
      sortBySubmissionDate(samples) {
        return samples.sort(function(a,b) {
          a = a.submission
          b = b.submission
          if (a && !b || !b && !a) return -1
          if (b && !a) return 1
          a_date = a.split("-")
          b_date = b.split("-")
          return  new Date(b_date[0],b_date[1]-1,b_date[2]) - new Date(a_date[0],a_date[1]-1,a_date[2]) 
        })
      },
      setRunStatus(status) {
        let variant = "secondary"
        let run_status = {
          dark: 'idle',
          info: 'running',
          primary: 'archiving',
          danger: 'error',
          success:'complete'}
        Object.entries(run_status).forEach(([key, val]) => {
          if(status.includes(val)) {
            variant = key
          }
        });
        return variant
      },
      fetchSamples () {
        if (this.radio !== "Wetlab") var data =  {"type" : "fetchSample", "name" : this.radio}
        else  var data =  {"type" : "fetchWetlab"}
        
        this.axiosColossus(data)
        .then((r) => {
          console.log(r.samples)
          this.samples = this.sortBySubmissionDate(r.samples)
          for (let i = 0; i < this.samples.length; i ++) {
            Vue.set(this.samples[i], "pipeline", {"qc":"secondary", "align": "secondary", "hmmcopy": "secondary", "pseudo": "secondary"})
            Vue.set(this.samples[i],"imported","background-color: #ffffff")
            if(this.samples[i].jira) {
              this.axiosVerifyTantalus(this.samples[i])
              this.axiosVerifyColossus(this.samples[i])
              }
          }          
          if(this.montage_ready) this.updateSampleMontage()
        })
      },
      axiosVerifyColossus(sample){
        // ff7043ffffff
        this.axiosColossus({"type" : "validateColossus", "id" : sample.jira})
        .then((r) => {if(r) sample.imported = "background-color: #e8f5e9"})
      },
      axiosVerifyTantalus (sample) {
        jira = sample.jira
        library = sample.library
        let token = "JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxNiwidXNlcm5hbWUiOiJqcGhhbSIsImV4cCI6MTU2NDAwMTEzMSwiZW1haWwiOiIiLCJvcmlnX2lhdCI6MTU2MzM5NjMzMX0.DpU0SFgS390B1KCMKI3bUMVUwFocw3X-Qodlz8K848A"
        const url = "https://tantalus.canadacentral.cloudapp.azure.com/api/analysis/"        
        // Qc, hmmcopy and align 
        axios
        .get(url,{  params : {jira_ticket : jira}, auth: {username: this.username,password: this.password},})
        .then(r => {
          r.data.results.forEach(a => {
            atype = a.analysis_type
            status = a.status
            if (atype in sample.pipeline) sample["pipeline"][atype]= this.setRunStatus(status)
            })
            if ((sample.pipeline["align"] === "success") && (sample.pipeline["hmmcopy"] === "success")) sample["pipeline"]["qc"]= "success"
            if (sample.pipeline["qc"]=== "success"){
              sample.pipeline["align"] = "success"
              sample.pipeline["hmmcopy"] = "success"
            } 
          })
        .catch(e => {console.log(e.response)})

        // Pseudobulk
        axios
        .get(url,{auth: {username: this.username,password: this.password},
        params : {input_datasets__library__library_id : library, analysis_type__name: "pseudobulk"}})
        .then(r => {if(r.data.count > 0) sample["pipeline"]["pseudo"]= this.setRunStatus(status)})
        .catch(e => {console.log(e.response)})        
      },
      axiosColossus(data){
        return new Promise(function(resolve, reject) {
          axios({
                method: 'post',
                url: "{% url 'core:pipeline_status_request_handler' %}",
                dataType: "json",
                data: data,
                headers: {
                  "X-CSRFToken": Cookies.get('csrftoken'),
                  "content-type": "application/json"
                }}).then( (response) => resolve(response.data)).catch( (e) => reject(e))
        })
      },
      updateSampleMontage() {
        this.samples.forEach( sample => {
          if(this.montages.includes(sample.jira)) var montage = true
          else var montage = false
          Vue.set(sample,  "montage", montage)
        })
      },
      axiosVerifyMontage() {
        this.axiosColossus({type : "fetchMontage"})
        .then((r) => {
          this.montage_ready=true
          this.montages = r
          this.updateSampleMontage()
        })

      }
    },
  })
</script>
{% include "core/vue/status-page-style.html" %}
{% endblock %}
