{% extends "../vue/header.html" %}
{% load staticfiles %}

{% block body %}
<div id="app">
  <b-container id="main-container">
    <b-row class="text-center custom-row">
      <b-col class="main-menu" style="margin-right: 4px">
        <md-card class="pipeline-tag">
          <md-card-content>
          <md-field>
            <label>Search by Title</label>
            <md-input v-model="search"></md-input>
          </md-field>
          </md-card-content>
          <md-divider></md-divider>
          <md-card-content class="tag-list">
            <button v-for="tag in tags" @click="fetchSamples(tag.id)" class="project-button" squared><span>{% verbatim %}{{tag.title}}{% endverbatim %}</span></button>
          </md-card-content>
          <md-card-actions >
                <md-button>Edit</md-button>
                <md-button>Add</md-button>
          </md-card-actions>
        </md-card>
      </b-col>
      <b-col cols="9"> 
        <md-card class="main-content"  >
          <br />
          <div class="main-table">
            <b-button-group style="margin-top : 1px; height: 40px;">
                <b-button squared class="menu-button" style="width:140px;">sample ID</b-button>                
                <b-button class="menu-button" style="width:100px;">library ID</b-button>
                <b-button class="menu-button" style="width:100px;">Analysis</b-button>
                <b-button class="menu-button" style="width:100px;">Version</b-button>
                <b-button class="menu-button" style="width:100px;">Montage</b-button>
                <b-button squared class="menu-button" style="width:169px;">Pipeline  </b-button>
                <b-button squared class="menu-button" style="width:110px;">Pseudobulk  </b-button>
            </b-button-group>
            <div class="content-table">         
              <Row v-for="sample in samples" :key="sample.id" :sample="sample" />
            </div>
          </div>
          <br />
        </md-card >
      </b-col>
    </b-row>
  </b-container>
</div>
<script>

var Row =  {
  props: ['sample'],
  methods: {
    setShow() {this.sample.show = !this.sample.show},
    returnURL(type,pk) { return window.origin + type + "/" + pk},
    returnJiraURL(jira) {return "www.bcgsc.ca/jira/browse/" + jira }
  },
  template: `
  <b-button-group @click="setShow" style="margin-top : 1px;">
    <b-button squared class="row-button sample-name" style="width:140px;" :href="returnURL('core/sample',sample.id)">{% verbatim %}{{sample.name}}{% endverbatim %}</b-button>
    <b-button v-if="sample.library" class="row-button" style="width:100px;" :href="returnURL('dlp/library',sample.library)">
        {% verbatim %}{{sample.library}}{% endverbatim %}
    </b-button>
    <b-button class="row-button" v-else style="width:100px;" >
    <b-badge variant="warning">No DLP</b-badge> 
    </b-button>
    <b-button v-if="sample.jira" class="row-button" style="width:100px;" :href="returnJiraURL(sample.jira)">
     {% verbatim %}{{sample.jira}}{% endverbatim %}
    </b-button>
    <b-button v-else class="row-button" style="width:100px;" >
    <b-badge variant="warning">No Analysis</b-badge> 
    </b-button>
    <b-button v-if="sample.version" class="row-button" style="width:100px;">
      <b-badge variant="primary">
      {% verbatim %}{{sample.version}}{% endverbatim %}
      </b-badge>
    </b-button>
    <b-button v-else class="row-button" style="width:100px;">N/A</b-button>
    <b-button class="menu-button" style="width:100px;">N/A</b-button>
    <b-button squared class="row-button">
      <b-badge :variant="sample.pipeline.align">align</b-badge>
      <b-badge :variant="sample.pipeline.hmmcopy">hmmcopy</b-badge>
      <b-badge :variant="sample.pipeline.qc">QC</b-badge>
    </b-button>
    <b-button squared class="row-button" style="width:110px;">
      <b-badge :variant="sample.pipeline.pseudo">pseudobulk</b-badge>
    </b-button>
  </b-button-group>   
  `
  }
          

  var vm = new Vue({
    el: '#app',
    data: {
      samples: [],
      tags: [],
      search: "",
    },
    methods: {  
      setPipeline(i) {
        console.log("HELLO")
        this.samples[i].pipeline["qc"] = "primary"
      },    
      setRunStatus(status) {
        run_status = { secondary: ['idle'],
        info: ['running','archiving'],
        danger: ['error'],
        success:['complete', 'align_complete', 'hmmcopy_complete']}

      },
      fetchSamples (id) {
        axios({
                method: 'post',
                url: "{% url 'core:pipeline_status_request_handler' %}",
                dataType: "json",
                data: {"type" : "fetchSample", "id" : id},
                headers: {
                  "X-CSRFToken": Cookies.get('csrftoken'),
                  "content-type": "application/json"
                }}
            ).then( (response) => {
              this.samples = response.data.samples  
              this.samples.forEach( sample => {
                sample.pipeline = {qc:"secondary", align: "secondary", hmmcopy: "secondary", pseudo: "secondary"}
                if(sample.jira) this.axiosVeifyTantalus(sample)
              })
              }
              )
      },
      axiosVeifyTantalus (sample) {
        jira = sample.jira
        library = sample.library
        let token = "JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxOCwidXNlcm5hbWUiOiJzc29uZyIsImV4cCI6MTU2MzQwMTg5NSwiZW1haWwiOiIiLCJvcmlnX2lhdCI6MTU2Mjc5NzA5NX0.hP70bhBNncnE4uLdb5hJUoHQga3Ocv63sB2wz0ujn5c"
        const url = "http://127.0.0.1:8001/api/analysis/"
        
        // Qc, hmmcopy and align 
        axios
        .get(url,{ headers : { Authorization : token},
        params : {jira_ticket : jira}})
        .then(r => {
          r.data.results.forEach(a => {
            atype = a.analysis_type
            if (atype in sample.pipeline) sample["pipeline"][atype]= "primary"})
            if (sample.pipeline["align"] && sample.pipeline["hmmcopy"]) sample["pipeline"]["qc"]= "primary"})
        .catch(e => {console.log(e.response)})

        // Pseudobulk
        axios
        .get(url,{ headers : { Authorization : token},
        params : {input_datasets__library__library_id : library, analysis_type__name: "pseudobulk"}})
        .then(r => {if(r.data.count > 0) sample["pipeline"]["pseudo"]= "primary"})
        .catch(e => {console.log(e.response)})        
      }
    },
    components:{
      Row
    },
    created () {
      this.tags = JSON.parse(unescape("{{tags| safe | escapejs}}"))
      this.samples = JSON.parse(unescape("{{samples| safe | escapejs}}"))
      console.log(this.samples)
    },
  })
</script>

<style>
#main-container {
  padding-top: 4%;
}

a { text-decoration : none; color : #000; }

.wrap-button {
  height: 45px;
}

.sample-name {
  font-size: 10px;
  text-align: left;
  font-weight: 800;
}

.row-button {
  background-color:whitesmoke;
  color: black;
}


.tag-list {
            max-height:500px;
      overflow-y: scroll;
    }

.menu-button {
  background-color:rgb(190, 182, 182);
  color: black;
}

a {
  color: hotpink;
}

.row-description {
  background-color:whitesmoke;
  border: 0.5px solid grey;
  
}

.main-menu {
  max-width: 200px;
}

.tag-list {
  height: 430px;
}

.main-content {
  width: 1000px;
}

.project-button {
  border: none;
  background-color: #a9a9b0;
  width: 160px;
  height: 33px;
  margin: 1px;
}

.pipeline-tag {
  width: 200px;
  height: 600px;
}

.content-table {
  overflow: scroll;
  max-height: 600px;
}

.main-table {
  
  border-radius: 5px;
  width: 100%;
}

.menu-table {
  
}
.content-table {
  
}


.custom-row {
  
}

.column { 
  border: 1px solid black;
}
/* .main-card {
  margin-top: 100px;
  width: 1200px;
  height: 600px;
    

} */

</style>

{% endblock %}

